Build Notes:

PTLIB -
	configured by:
./configure --enable-opal --disable-dependency-tracking --disable-shared
The '--enable-opal' turns off all unneeded options. In addition,
configure script modified to turn off :

./configure --enable-minsize --enable-resolver --enable-dtmf --disable-video --enable-configfile
default_openssl=yes
default_expat=yes
default_sdl=yes
HAS_WAVFILE=1
HAS_VIDEO=1

to

default_openssl=no
default_expat=no
default_sdl=no
HAS_WAVFILE=
HAS_VIDEO=

Using the 'HAS_TELNET=' generated from '--enable-opal' requires fix to
ptlib/src/ptclib/cli.cxx to remove last two telnet referencing classes,
otherwise undefined symbol on t38modem Build

build with:
make opt

'opt' turns compiler optimization on

WHEN modifying 'tlibthrd.cxx' must touch 'src/ptlib/unix/tlib.cxx' because 'tlibthrd.cxx' is included
ALSO if t38modem crashing try a make clean in both OPAL and PTLIB

on linux make with:
sudo make opt install
- this puts libraries & headers in place

OPAL
	configured by
    ./configure --disable-java --disable-ruby --disable-video --disable-h323 --disable-iax2 --disable-h224 --disable-h281 --disable-msrp --disable-h450 --disable-h460 --disable-h239 --disable-h501 --disable-t120 --disable-lid --disable-ivr --disable-rfc4175 --disable-rfc2435 --disable-mixer --disable-pcss --disable-samples

  --enable-versioncheck   enable ptlib versioncheck
  --enable-localspeexdsp  Force use local version of Speex DSP library for
                          echo cancellation rather than system version
  --enable-zrtp           enable ZRTP protocol support
  --enable-srtp           enable SRTP protocol support
  --enable-capi           enable CAPI
  --disable-java           enable Java JNI support
  --disable-ruby           enable Ruby support
  --disable-video          whether to enable video codec support
  --enable-sip            whether to enable SIP protocol support
  --disable-h323           whether to enable H.323 protocol support
  --disable-iax2           whether to enable IAX2 protocol support
  --disable-h224           whether to enable H.224 protocol support
  --disable-h281           whether to enable H.281 (Far End Camera Control)
                          protocol support
  --enable-t38            whether to enable T.38 capability support
  --disable-msrp           whether to enable MSRP support
  --enable-sipim         (won't build without) whether to enable SIPIM session support (instant messaging)
  --enable-rfc4103       (won't build without) whether to enable RFC4103 support
  --enable-fax            whether to enable T.38 FAX protocol support
  --disable-h450           whether to enable H.450
  --disable-h460           whether to enable H.460
  --disable-h239           whether to enable H.239
  --disable-h501           whether to enable H.501
  --disable-t120           whether to enable T.120
  --disable-lid            whether to enable LID support
  --disable-ivr            whether to enable IVR support
  --disable-rfc4175        whether to enable RFC4175 support
  --disable-rfc2435        whether to enable RFC2435 support (experimental)
  --enable-aec            whether to enable accoustic echo cancellation
                          support
  --enable-g711plc        whether to enable Packet Loss Concealment for G.711
  --enable-rtcpxr         whether to enable RTCP Extended Reports support
  --enable-statistics     whether to enable statistics gathering support
  --disable-mixer          whether to enable media mixing support
  --disable-pcss           whether to enable PC sound system support
  --enable-plugins        whether to enable plugin support
  --disable-samples        whether to enable samples build



 
 --disable-shared must remove build of shared library version, we are using linked in
 library to reduce deliverables. 'disable-dependency-tracking' does not appear in configure
 and may not be needed.

Make with:
	make opt
	
In configure default options changed to reduce code set;
OPAL_H323=no
OPAL_SIP=yes
OPAL_IAX2=no
OPAL_VIDEO=no
OPAL_T38_CAPABILITY=yes
OPAL_FAX=yes
OPAL_HAS_H224=no
OPAL_HAS_H281=no
OPAL_H450=no
OPAL_H460=no
OPAL_H239=no
OPAL_H501=no
OPAL_T120DATA=no
OPAL_LID=no
OPAL_STATISTICS=yes
OPAL_AEC=no
OPAL_IVR=no
OPAL_RFC4175=no
OPAL_G711PLC=yes
OPAL_PLUGINS=yes
OPAL_SAMPLES=no
OPAL_ZRTP=no
OPAL_SHARED_LIB=no
OPAL_JAVA=no
OPAL_RUBY=no
OPAL_HAS_MSRP=no
OPAL_HAS_SIPIM=no
OPAL_HAS_RFC4103=no
OPAL_HAS_MIXER=no
OPAL_HAS_PCSS=no

Edits where needed to a 'OPAL_PTLIB_WAVFILE' in opal/src/opal/mediafmt.cxx and
opal/src/codec/opalpluginmgr.cxx to added 'OPAL_PTLIB_WAVFILE' around header include
and case statement in switch with refences to 'wav'
#if OPAL_PTLIB_WAVFILE
#include <codec/opalwavfile.h>
#endif

Results in 2.7 mb t38modem binary.

Release Package:

cd /source/hylafax-6.0.4/acordex
sudo ./makeinstall

T38Modem Checkout new source:

Change to directory and run:

cvs -d:pserver:anonymous@t38modem.cvs.sourceforge.net:/cvsroot/t38modem checkout t38modem

T38 Protocol

Some redundancy in UDPTL is needed, have observed low speed HDLC packets sending
initial fax NSF and TSI being lost causing retransmission at fax level. Flags
to T38 modem:

--sip-t38-udptl-redundancy 2:3,9:3,32767:2

results in small command packets, CNG, No-Signal, V21-preamble being retransmitted
as seperate UDP packets with same sequence number 3 times.
Low speed data packets containing fax control data are sent as one packet, with
3 redundancy packets added. Note that first data packet has no reduncancy,
second 1 redundancy and third 2 redundancy. The final control packet after data packets
have the redundancy of the last data packets.

First HDLC packet - FF
0010  00 27 37 4b 00 00 40 11  22 2b c0 a8 5a f7 04 37   .'7K..@. "+..Z..7
0020  00 c2 13 96 70 60 00 13  20 bd 06 a1 06 c0 01 80   ....p`..  .......
0030  00 00 ff 00 00                                     .....            

Second HDLC -C8 - with one redundant packet:
0000  00 13 f7 9e 76 dd 00 16  cb ae a2 06 08 00 45 b8   ....v... ......E.
0010  00 2e 24 71 00 00 40 11  34 fe c0 a8 5a f7 04 37   ..$q..@. 4...Z..7
0020  00 c2 13 96 70 60 00 1a  20 c4 06 a2 06 c0 01 80   ....p`..  .......
0030  00 00 c8 00 01 06 c0 01  80 00 00 ff               ........ ....    

Third HDLC - DF - with 2:
0000  00 13 f7 9e 76 dd 00 16  cb ae a2 06 08 00 45 b8   ....v... ......E.
0010  00 35 57 3a 00 00 40 11  02 2e c0 a8 5a f7 04 37   .5W:..@. ....Z..7
0020  00 c2 13 96 70 60 00 21  20 cb 06 a3 06 c0 01 80   ....p`.!  .......
0030  00 00 df 00 02 06 c0 01  80 00 00 c8 06 c0 01 80   ........ ........
0040  00 00 ff                                           ...              

4th (FCS-OK) with 3:
0000  00 13 f7 9e 76 dd 00 16  cb ae a2 06 08 00 45 b8   ....v... ......E.
0010  00 39 96 31 00 00 40 11  c3 32 c0 a8 5a f7 04 37   .9.1..@. .2..Z..7
0020  00 c2 13 96 70 60 00 25  20 cf 06 a4 03 c0 01 20   ....p`.%  ...... 
0030  00 03 06 c0 01 80 00 00  df 06 c0 01 80 00 00 c8   ........ ........
0040  06 c0 01 80 00 00 ff                               .......          

5th (Sig-End) with 3:
0000  00 13 f7 9e 76 dd 00 16  cb ae a2 06 08 00 45 b8   ....v... ......E.
0010  00 36 02 72 00 00 40 11  56 f5 c0 a8 5a f7 04 37   .6.r..@. V...Z..7
0020  00 c2 13 96 70 60 00 22  20 cc 06 a5 03 c0 01 10   ....p`."  .......
0030  00 03 03 c0 01 20 06 c0  01 80 00 00 df 06 c0 01   ..... .. ........
0040  80 00 00 c8                                        ....             

6th - no-sig with 3
0000  00 13 f7 9e 76 dd 00 16  cb ae a2 06 08 00 45 b8   ....v... ......E.
0010  00 31 cc 19 00 00 40 11  8d 52 c0 a8 5a f7 04 37   .1....@. .R..Z..7
0020  00 c2 13 96 70 60 00 1d  20 c7 06 a6 01 00 00 03   ....p`..  .......

7th - repeat of no-sig same sequence num with 2
0000  00 13 f7 9e 76 dd 00 16  cb ae a2 06 08 00 45 b8   ....v... ......E.
0010  00 2a 76 12 00 00 40 11  e3 60 c0 a8 5a f7 04 37   .*v...@. .`..Z..7
0020  00 c2 13 96 70 60 00 16  20 c0 06 a6 01 00 00 02   ....p`..  .......
0030  03 c0 01 10 03 c0 01 20

8th - 2nd repeat of no-sig same sequence num with 1
0000  00 13 f7 9e 76 dd 00 16  cb ae a2 06 08 00 45 b8   ....v... ......E.
0010  00 26 9f 60 00 00 40 11  ba 16 c0 a8 5a f7 04 37   .&.`..@. ....Z..7
0020  00 c2 13 96 70 60 00 12  20 bc 06 a6 01 00 00 01   ....p`..  .......
0030  03 c0 01 10 

9th - 3rd repeat of no-sig same sequence num with 0
0000  00 13 f7 9e 76 dd 00 16  cb ae a2 06 08 00 45 b8   ....v... ......E.
0010  00 22 5a 05 00 00 40 11  ff 75 c0 a8 5a f7 04 37   ."Z...@. .u..Z..7
0020  00 c2 13 96 70 60 00 0e  20 b8 06 a6 01 00 00 00   ....p`..  .......

Fax Data Packets have two redundant packets:
-- data packets are 35 hex long, appears to be adjusted down
from 47 hex when only one redundant packet

0000  00 13 f7 9e 76 dd 00 16  cb ae a2 06 08 00 45 b8   ....v... ......E.
0010  00 d4 45 35 00 00 40 11  13 94 c0 a8 5a f7 04 37   ..E5..@. ....Z..7
0020  00 c2 13 96 70 60 00 c0  21 6a 06 5f 3b d0 01 e0    06 5f = seq num, 3b = length of whole packet
0030  00 35  <-- data packet length - 1
            00 01 ee b0 9d 52  f9 fb ef 4f dd 92 2f b2   .5.....R ...O../.
0040  a5 d5 dd 61 13 bf be f3  d1 75 4b dd d1 74 a0 fa   ...a.... .uK..t..
0050  bf 0c 88 f7 4f df 7b 9a  f8 13 ad 60 9d d9 65 17   ....O.{. ...`..e.
0060  4a 20 e1 17 54 c0 a9 8a  
                               00 02  <-- redundant packet count
                                     3b d0 01 e0 00 35   J ..T... ..;....5
0070  06 48 b8 67 e2 90 a0 01  48 5c 5d 3d 56 93 d0 d3   .H.g.... H\]=V...
0080  d7 4f 4d dd 75 58 f4 fc  4a 8d 38 61 eb 43 d3 75   .OM.uX.. J.8a.C.u
0090  5d 0c 85 c5 e9 3f d3 f0  bd 72 1b fa d2 4b ff d4   ]....?.. .r...K..
00a0  7a 7a 6e 15 3f 0a 3b d0  01 e0 00 35 4a 8a 04 a8   zzn.?.;. ...5J...
00b0  b8 ba f1 29 c4 a7 ca e6  8b 81 9a 5d a2 e0 6c 37   ...).... ...]..l7
00c0  d1 79 06 64 17 18 94 e2  53 d1 79 e2 54 4c ee fd   .y.d.... S.y.TL..
00d0  17 03 c9 cb eb 86 c5 69  69 25 ff f5 2b 9a 2e 06   .......i i%..+...
00e0  8b 89   (226 dec whole packet length)              ..               


with only one redundant packet, size is adjusted up to 47 hex (71 bytes)

0000  00 16 cb ae a2 06 00 13  f7 9e 76 dd 08 00 45 20   ........ ..v...E 
0010  00 bc 00 00 40 00 39 11  1b f9 04 37 05 42 c0 a8   ....@.9. ...7.B..
0020  5a f7 67 70 13 8a 00 a8  00 00 00 b6 4d d0 01 e0   Z.gp.... ....M...
0030  00 47

            05 00 1a 6c d4 00  50 01 40 05 00 1a 6c d4   .G...l.. P.@...l.
0040  00 50 01 40 05 00 1a 6c  d4 00 50 01 40 05 00 1a   .P.@...l ..P.@...
0050  6c d4 00 50 01 40 05 00  1a 6c d4 00 50 01 40 05   l..P.@.. .l..P.@.
0060  00 1a 6c d4 00 50 01 40  05 00 1a 6c d4 00 50 01   ..l..P.@ ...l..P.
0070  40 05 00 1a 6c d4 00 50  01 40
                                     00 01 4d d0 01 e0   @...l..P .@..M...
0080  00 47
            05 00 1a 6c d4 00  50 01 40 05 00 1a 6c d4   .G...l.. P.@...l.
0090  00 50 01 40 05 00 1a 6c  d4 00 50 01 40 05 00 1a   .P.@...l ..P.@...
00a0  6c d4 00 50 01 40 05 00  1a 6c d4 00 50 01 40 05   l..P.@.. .l..P.@.
00b0  00 1a 6c d4 00 50 01 40  05 00 1a 6c d4 00 50 01   ..l..P.@ ...l..P.
00c0  40 05 00 1a 6c d4 00 50  01 40                     @...l..P .@      


0000  00 16 cb ae a2 06 00 13  f7 9e 76 dd 08 00 45 20   ........ ..v...E 
0010  00 bc 00 00 40 00 39 11  1b f9 04 37 05 42 c0 a8   ....@.9. ...7.B..
0020  5a f7 67 70 13 8a 00 a8  00 00 00 cd 4d d0 01 e0   Z.gp.... ....M...
0030  00 47
            05 00 1a 6c d4 00  50 01 40 05 00 1a 6c d4   .G...l.. P.@...l.
0040  00 50 01 40 05 00 1a 6c  d4 00 50 01 40 05 00 1a   .P.@...l ..P.@...
0050  6c d4 00 50 01 40 05 00  1a 6c d4 00 50 01 40 05   l..P.@.. .l..P.@.
0060  00 1a 6c d4 00 50 01 40  05 00 1a 6c d4 00 50 01   ..l..P.@ ...l..P.
0070  40 05 00 1a 6c d4 00 50  01 40
                                     00 01 4d d0 01 e0   @...l..P .@..M...
0080  00 47 05 00 1a 6c d4 00  50 01 40 05 00 1a 6c d4   .G...l.. P.@...l.
0090  00 50 01 40 05 00 1a 6c  d4 00 50 01 40 05 00 1a   .P.@...l ..P.@...
00a0  6c d4 00 50 01 40 05 00  1a 6c d4 00 50 01 40 05   l..P.@.. .l..P.@.
00b0  00 1a 6c d4 00 50 01 40  05 00 1a 6c d4 00 50 01   ..l..P.@ ...l..P.
00c0  40 05 00 1a 6c d4 00 50  01 40                     @...l..P .@      


0000  00 16 cb ae a2 06 00 13  f7 9e 76 dd 08 00 45 20   ........ ..v...E 
0010  00 bc 00 00 40 00 39 11  1b f9 04 37 05 42 c0 a8   ....@.9. ...7.B..
0020  5a f7 67 70 13 8a 00 a8  00 00 02 44 4d d0 01 e0   Z.gp.... ...DM...
0030  00 47
            78 2c 7d d9 40 f0  bb f9 ca 7e 4e 38 e7 bf   .Gx,}.@. ...~N8..
0040  1d 8e 05 eb b3 70 40 01  7e f1 86 fc d9 c1 02 1d   .....p@. ~.......
0050  61 b0 ff ff ff f3 10 c1  d7 ff ac 36 1b f5 ff c3   a....... ...6....
0060  ff 1f ef df 39 1e 3f f8  5f f1 f7 f1 7f d4 ef 9c   ....9.?. _.......
0070  38 3f b1 ff fd 7d f3 4f  83 72 00 01
                                           4d d0 01 e0   8?...}.O .r..M...
0080  00 47 c5 c2 b1 cf 7a 2b  de cd c5 81 6c ac ac 73   .G....z+ ....l..s
0090  fb 1f ce 7d ce 2c 0f bc  9f 1f 7e 27 b2 ba 37 ec   ...}.,.. ..~'..7.
00a0  5b 1f f7 8e 9f 7b ae 1f  54 12 3b e0 58 e4 2f 39   [....{.. T.;.X./9
00b0  c4 fb cf 06 a2 bf 21 fc  9c 58 17 0a 07 fc 63 c3   ......!. .X....c.
00c0  ef 65 99 ca 3f dc 59 8e  3c e0                     .e..?.Y. <.    

12000 baud UDPTL packet:

0000  00 13 f7 9e 76 dd 00 16  cb ab 4b 6b 08 00 45 b8   ....v... ..Kk..E.
0010  00 53 be bd 00 00 40 11  e6 56 c0 a8 5a f7 42 2a   .S....@. .V..Z.B*
0020  77 04 13 96 8f fc 00 3f  d5 1e 02 7e 32 ce 01 e0   w......? ...~2...
0030  00 2c
			00 1a 6c d4 00 01  40 01 40 01 40 01 a6 cd   .,..l... @.@.@...
0040  40 01 40 01 14 c1 03 80  01 19 60 72 69 15 28 84   @.@..... ..`ri.(.
0050  88 71 16 0a 4d 91 94 65  5c 4b 91 dc cc ab 89 00   .q..M..e \K......
0060  00                                                 .                


// This is interpretted differently in different specs, it is either the max fax data size
// = (ms per sample * 14400) / (8000) = 72, or the make UPTDL payload which is affected by the
// redundancy amount. Currently we have two redundant packets to the size works out to be:
//  = (ms per sample * 14400) / (8000) = 72 * 3 + 6 * 3 (IFP Size, type, data field count, field type, data length)
// + 2 (redundant field count) + 2 (UDPTL sequence number). = 238
// There is also 42 bytes of IP/UDP header so packet size is + 42

SIP Protocol: Invite:

INVITE sip:9782964484@74.94.184.154:5060 SIP/2.0
Via: SIP/2.0/UDP 64.136.174.35:5060;branch=z9hG4bK1sansay401228999rdb4933
Record-Route: <sip:sansay401228999rdb4933@64.136.174.35:5060;lr;transport=udp>
To: <sip:9782964484@74.94.184.154>
From: "Lawrence     MA " <sip:19782084044@64.136.174.35>;tag=sansay401228999rdb4933
Call-ID: 60255227-0-2193376084@64.136.164.226
CSeq: 1 INVITE
Contact: <sip:19782084044@64.136.174.35:5060>
Supported: timer
Session-Expires: 1800;refresher=uac
Min-SE: 90
P-Asserted-Identity: "Lawrence     MA " <sip:+19782084044@4.55.1.99:5060>
Max-Forwards: 92
Content-Type: application/sdp
Content-Length: 297

v=0
o=Sansay-VSXi 188 1 IN IP4 64.136.174.35
s=Session Controller
c=IN IP4 4.55.1.66
t=0 0
m=audio 16878 RTP/AVP 0 8 18 101
a=rtpmap:0 PCMU/8000
a=rtpmap:8 PCMA/8000
a=rtpmap:18 G729/8000
a=fmtp:18 annexb=no
a=rtpmap:101 telephone-event/8000
a=fmtp:101 0-15
a=sendrecv
a=maxptime:20

Install Network Notes:

If IP of system is not authorized by VOIP and SIP 403 Not Authorized is returned, and message seen
in T38Log.

If system has a bad idea of its own external IP, either because this has changed since T38Modem
started, or STUN server not used/not working, then the call will go through, you will hear fax
tone, but connection will fail because the incoming packets from the remote end
will not be seen.


